<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en-gb"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en-gb"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en-gb"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en-gb"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Nice to have</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <!-- You can also compile style.less to use regular css. Your apps will still work. -->
  <style type="text/css">body{padding-top:60px}.hidden{margin:20px;border:5px solid #a24c4c;background-color:red;padding:10px;width:400px;color:white;font-family:helvetica,sans-serif}</style>
  <link rel="stylesheet/less" type="text/css" href="kickstrap.less">
  <script src="Kickstrap/js/less-1.3.0.min.js"></script>
  <script src="js/d3.v3.min.js"></script>
  <script src="Kickstrap/js/jquery-1.8.3.min.js"></script>
  <script src="js/knockout-2.2.0.js"></script>
  <script src="https://api.trello.com/1/client.js?key=afaec27e30009b0b1cfb14d85f384ee1"></script>
  <style>
      svg {
          /*border: 1px solid;*/
      }

      circle.card {
          stroke: #fff;
          stroke-width: 1.5px;
      }

      .selecting circle.card {
          fill-opacity: .2;
      }

      .selecting circle.card.selected {
          stroke: #f00;
      }

      div.card {
          margin-bottom: 5px;
      }

      .selecting div.card {
          opacity:.2;
      }

      .selecting div.card.selected {
          opacity: 1.0;
      }

      .brush .extent {
          stroke: #fff;
          fill-opacity: .125;
          shape-rendering: crispEdges;
      }

      table#board {
          font-family: "Trebuchet MS", sans-serif;
          font-size: 16px;
          font-weight: bold;
          line-height: 1.4em;
          font-style: normal;
          border-collapse:separate;
          height: 500px;
      }

      table#board thead th {
          padding:15px;
      }

      table#board tbody th {
          padding:15px;
      }

      table#board tbody .area.even {
          background-color: rgb(243, 253, 255);
      }
      table#board tbody .area.uncategorized {
          background-color: rgb(197, 228, 230);
      }
  </style>
</head>
<body>
<div id="sf-wrapper"> <!-- Sticky Footer Wrapper -->
  <!-- Prompt IE 6/7 users to install Chrome Frame. Remove this if you support IE 7-.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 8]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
<!--! END KICKSTRAP HEADER -->


    <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <a class="brand" href="#">Nice to have</a>
                <div class="nav-collapse">
                    <ul class="nav">
                        <li><a href="/">Home</a></li>
                        <li class="active"><a href="app.html">The App</a></li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="span12">
                <input data-bind="value: board.id" />

                <button class="btn" data-bind="click: useBoard"><i class="icon-refresh"></i> Use this</button>

                <span data-bind="text: board.name"></span>
            </div>

            <section class="row">
                <div class="span7">
                    <table id="board" cellspacing="0" cellpadding="0">
                        <col width="10%"/>
                        <col width="30%"/>
                        <col width="30%"/>
                        <col width="30%"/>
                        <thead>
                            <tr>
                                <th></th>
                                <th scope="col">Nice to Have</th>
                                <th scope="col">Significant Business Value</th>
                                <th scope="col">Critical</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">Low risk</th>
                                <td class="area even origin"></td>
                                <td class="area odd"></td>
                                <td class="area even"></td>
                            </tr>
                            <tr>
                                <th scope="row">Medium risk</th>
                                <td class="area odd"></td>
                                <td class="area even"></td>
                                <td class="area odd"></td>
                            </tr>
                            <tr>
                                <th scope="row">High risk</th>
                                <td class="area even"></td>
                                <td class="area odd"></td>
                                <td class="area even"></td>
                            </tr>
                            <tr>
                                <th scope="row">Uncategorized</th>
                                <td class="area uncategorized"></td>
                                <td class="area uncategorized"></td>
                                <td class="area uncategorized"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="span5">
                    <select data-bind="options: board.lists, value: selectedList, optionsText: 'name', enable: board.lists().length > 0"></select>

                    <div data-bind="visible: selectedList, with: selectedList">
                        <h3>Cards: <span data-bind="text: cards().length"></span></h3>
                        <div data-bind="foreach: cards">
                            <div class="card row" data-bind="css: { selected: selected }">
                                <button class="span1 btn btn-mini btn-primary" type="button" data-bind="click: addToArea"><i class="icon-arrow-left"></i> </button>
                                <div class="span4" data-bind="text: name"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </div>

<script type="application/javascript">

$(function() {
    function Board() {
        // Data
        var self = this;
        self.id = ko.observable("4ed7e27fe6abb2517a21383d");
        self.lists = ko.observableArray([]);
        self.name = ko.observable("");

        // Operations
        self.refresh = function() {
            Trello.boards.get(self.id(), function(results) {
                console.log("Fetched board info");
                console.dir(results);
                self.name(results.name);
                Trello.boards.get(self.id() + "/lists", function(results) {
                    console.log("Fetched board lists");
                    self.lists([]);
                    console.dir(results);
                    results.forEach(function(d) {
                        self.lists.push(new List(d));
                    })
                });
            });
        }
    }

    function List(data) {
        var self = this;
        self.id = ko.observable(data.id);
        self.name = ko.observable(data.name);
        self.cards = ko.observableArray([]);
        self.cardsInArea = ko.computed(function() {
            return self.cards().filter(function(c) {
                return c.inArea();
            });
        });

        self.refresh = function() {
            Trello.lists.get(self.id() + "/cards", function(results) {
                console.log("Fetched cards");
                console.dir(results);
                self.cards([]);
                results.forEach(function(d) {
                    self.cards.push(new Card(d));
                })
            });
        }
    }

    function Card(data) {
        var self = this;
        self.id = ko.observable(data.id);
        self.name = ko.observable(data.name);
        self.selected = ko.observable(false);
        self.inArea = ko.observable(false);

        self.addToArea = function() {
            self.inArea(true);
        };

        self.removeFromArea = function() {
            self.inArea(false);
        };
    }

    function NiceToHaveAppViewModel() {
        // Data
        var self = this;
        self.board = new Board();
        self.list = new List({id: "4eea755f1576578f2713ec56"});
        self.selectedList = ko.observable();
        self.loggedIn = ko.observable(Trello.authorized());

        self.selectedList.subscribe(function(list){
            console.log("Selected list changed");
            list.cardsInArea.subscribe(function(cards) {
                update(cards);
            });
            list.refresh();
        });

        // Operations
        self.useBoard = function() {
            console.log("Update board: " + self.board.id());
            self.board.refresh();
        }
    }

    var model = new NiceToHaveAppViewModel();

    ko.applyBindings(model);

    var $board = $("#board");
    var boardOffset = $board.offset();
    var boardDimension = {
        width: $board.width(),
        height: $board.height()
    };
    var originOffset = $("#board .origin").offset();

    var width = boardDimension.width - (originOffset.left - boardOffset.left);
    var height = boardDimension.height - (originOffset.top - boardOffset.top);

    var svg = d3.select("body")
            .append("svg")
            .style("position", "absolute")
            .style("top", originOffset.top + "px")
            .style("left", originOffset.left + "px")
            .attr("width", width)
            .attr("height", height);

    var force = d3.layout.force()
            .charge(-2)
            .gravity(0)
            .size([width, height]);

    force
            .nodes([])
            .links([])
            .start();

    var maxRadius = 7;

    function clampX(x) {
        return Math.max(maxRadius, Math.min(x, width - maxRadius))
    }

    function clampY(y) {
        return Math.max(maxRadius, Math.min(y, height - maxRadius))
    }

    var valueScale = d3.scale.linear()
            .domain([0, 3])
            .range([0, width])
            .clamp(true);

    var riskScale = d3.scale.linear()
            .domain([0, 4])
            .range([0, height])
            .clamp(true);

    var values = ['N','S','C'];
    var risks = ['L','M','H','U'];

    var brush = d3.svg.brush()
            .x(valueScale)
            .y(riskScale)
            .on("brushstart", brushstart)
            .on("brush", brush)
            .on("brushend", brushend);

    var selecting = false;

    function brushstart() {
        console.log("Brush Start");
        selecting = true;
        d3.select("body").classed("selecting", selecting);
        svg.selectAll("circle.card")
                .on('mousedown.drag', null)
                .each(function(c) {
                    c.fixed = true;
                });
    }

    function brush() {
        console.log("Brush");
        var e = d3.event.target.extent();
        svg.selectAll("circle.card").classed("selected", function(c) {
            var value = valueScale.invert(c.x);
            var risk = riskScale.invert(c.y);
            var inSelection = e[0][0] <= value && value <= e[1][0]
                    && e[0][1] <= risk && risk <= e[1][1];
            c.selected(inSelection);
            return inSelection;
        });
    }

    function brushend() {
        selecting = !d3.event.target.empty();
        console.log("Brush End, Selecting: " + selecting);
        d3.select("body").classed("selecting", selecting);
        if (!selecting) {
            svg.selectAll("circle.card")
                    .call(force.drag)
                    .each(function(c) {
                        c.fixed = false;
                    });
        }
    }

    svg.append("g")
            .attr("class", "brush")
            .call(brush);

    function update(cards) {
        force
                .nodes(cards)
                .links([])
                .start();

        var existingCards = svg.selectAll("circle.card")
                .data(cards, function(d) { return d.name(); });

        var newCards = existingCards.enter();

        newCards
                .append("circle")
                .attr("class", "card")
                .attr("r", maxRadius)
                .each(function(c) {
                    c.y = riskScale(3 + Math.round(1.0));
                })
                .call(force.drag)
                .on("click", function(c) {
                    console.log("Clicked on ");
                    console.dir(c);
                    var value = Math.floor(valueScale.invert(c.x));
                    var risk = Math.floor(riskScale.invert(c.y));
                    console.log("Value: " + values[value]);
                    console.log("Risk: " + risks[risk]);
                })
                .append("title")
                .text(function(d) { return d.name(); });

        existingCards.exit().remove();

        force.on("tick", function() {
            existingCards
                    .attr("cx", function(d) { return d.x = clampX(d.x); })
                    .attr("cy", function(d) { return d.y = clampY(d.y); });
        });
    }

    Trello.authorize({
        interactive:false,
        success: model.updateLoggedIn
    });
});

</script>

  <!--! KICKSTRAP FOOTER -->
   <div class="hidden"><h1>No Stylesheet Loaded</h1><p><strong>Could not load Kickstrap.</strong>There are <a href="http://getkickstrap.com/docs/1.2/troubleshooting/#lessjs-errors">several common reasons for this error.</a></p></div>
  <div id="push"></div></div> <!-- sf-wrapper -->
  <footer class="container" id="footer">
	  <p>Built with <a href="http://getkickstrap.com">Kickstrap</a></p>
  </footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="Kickstrap/js/jquery-1.8.2.min.js"><\/script>');</script>
  <!-- Kickstrap CDN thanks to our friends at netDNA.com -->
  <script id="appList" src="//netdna.getkickstrap.com/1.2/Kickstrap/js/kickstrap.min.js"></script>
  <script>window.ks || document.write('<script id="appList" src="Kickstrap/js/kickstrap.min.js"><\/script>')</script>
  <script>

  </script>
  <!-- Asynchronous Google Analytics snippet. Change UA-XXXXX-X to be your site's ID.
       mathiasbynens.be/notes/async-analytics-snippet -->
  <!--script>
    var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script-->
</body>
</html>
