<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en-gb"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en-gb"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en-gb"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en-gb"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Nice to have</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <!-- You can also compile style.less to use regular css. Your apps will still work. -->
  <style type="text/css">body{padding-top:60px}.hidden{margin:20px;border:5px solid #a24c4c;background-color:red;padding:10px;width:400px;color:white;font-family:helvetica,sans-serif}</style>
  <link rel="stylesheet" type="text/css" href="/kickstrap.css">
  <script src="/Kickstrap/js/less-1.3.0.min.js"></script>
  <script src="/js/d3.v3.min.js"></script>
  <script src="/Kickstrap/js/jquery-1.8.3.min.js"></script>
  <script src="/js/jquery.blockUI.js"></script>
  <script src="https://api.trello.com/1/client.js?key=afaec27e30009b0b1cfb14d85f384ee1"></script>
  <script src="/js/knockout-2.2.0.js"></script>
  <script src="/js/sammy-0.7.2.min.js"></script>

  <script src="/js/model/card.js"></script>
  <script src="/js/model/list.js"></script>
  <script src="/js/model/board.js"></script>
  <script src="/js/model/persistence.js"></script>

  <script src="/js/ko.binding-handlers.js"></script>
  <script src="/js/d3.categorise.view.js"></script>
  <style>
      svg {
          /*border: 1px solid;*/
      }

      circle.card {
          stroke: #fff;
          stroke-width: 1.5px;
      }

      circle.card.highlighted {
          stroke: red;
          cursor: move;
      }

      .selecting circle.card {
          fill-opacity: .2;
      }

      .selecting circle.card.selected {
          stroke: #f00;
      }

      button.card {
          margin-top: 2px;
          margin-bottom: 2px;
          display: block;
          width: 100%;
      }

      button.card.highlighted {
          background-color: red;
      }

      .selecting button.card {
          opacity:.2;
      }

      .selecting button.card.selected {
          opacity: 1.0;
      }

      .brush .extent {
          stroke: #fff;
          fill-opacity: .125;
          shape-rendering: crispEdges;
      }

      table#area, div#cards {
          height: 500px;
      }

      div#cards {
          overflow-y: auto;
      }

      table#area thead th {
          padding:15px;
      }

      table#area tbody th {
          padding:15px;
      }

      table#area tbody .area.even {
          background-color: rgb(243, 253, 255);
      }
      table#area tbody .area.uncategorized {
          background-color: rgb(197, 228, 230);
      }

      #errors {
          display: none;
      }

      #errors.found {
          display: block;
      }
  </style>
</head>
<body>
<div id="sf-wrapper"> <!-- Sticky Footer Wrapper -->
  <!-- Prompt IE 6/7 users to install Chrome Frame. Remove this if you support IE 7-.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 8]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
<!--! END KICKSTRAP HEADER -->


    <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <a class="brand" href="/">Nice to have</a>
                <div class="nav-collapse">
                    <ul class="nav">
                        <li><a href="/">Home</a></li>
                        <li class="active"><a href="/app">The App</a></li>
                    </ul>

                    <ul class="nav pull-right">
                        <li><a href="https://github.com/mikemoraned/nicetohave-app">v<%= settings.version %></a></li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="row">
                <form class="well well-small form-inline">
                    <label for="board-id">Choose Board Id</label>
                    <input id="board-id" type="text" class="span3" data-bind="value: board.id" placeholder="Your Board Id">

                    <button type="submit" class="btn"data-bind="click: goToBoardId"><i class="icon-refresh"></i> Use this</button>

                    <label for="lists">Select List</label>
                    <select id="lists" data-bind="options: board.lists, value: selectedList, optionsText: 'name', enable: board.lists().length > 0"></select>
                </form>
            </div>
        </div>

        <section data-bind="css: persistence.saveState">

        <div class="row">
            <div class="span7">
                <table id="area" cellspacing="0" cellpadding="0">
                    <col width="10%"/>
                    <col width="30%"/>
                    <col width="30%"/>
                    <col width="30%"/>
                    <thead>
                        <tr>
                            <th></th>
                            <th scope="col">Nice to Have</th>
                            <th scope="col">Significant Business Value</th>
                            <th scope="col">Critical</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">Low risk</th>
                            <td class="area even origin"></td>
                            <td class="area odd"></td>
                            <td class="area even"></td>
                        </tr>
                        <tr>
                            <th scope="row">Medium risk</th>
                            <td class="area odd"></td>
                            <td class="area even"></td>
                            <td class="area odd"></td>
                        </tr>
                        <tr>
                            <th scope="row">High risk</th>
                            <td class="area even"></td>
                            <td class="area odd"></td>
                            <td class="area even"></td>
                        </tr>
                        <tr>
                            <th scope="row">Uncategorized</th>
                            <td class="area uncategorized"></td>
                            <td class="area uncategorized"></td>
                            <td class="area uncategorized"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="span5" data-bind="visible: selectedList, with: selectedList">
                <button class="btn btn-primary" type="button" data-bind="click: addAllToArea, enable: hasSomeNotInArea">
                    <i class="icon-arrow-left"></i> add all
                </button>

                <button class="btn btn-primary" type="button" data-bind="click: moveSelectedToTop, enable: hasSelected">
                    <i class="icon-arrow-up"></i> move to top
                </button>

                <button class="btn btn-primary" type="button" data-bind="click: persistence.saveAll, enable: persistence.canSaveAll">
                    <i class="icon-arrow-right"></i> save to trello
                </button>

                <div id="cards" data-bind="foreach: cards">
                    <button class="btn card" type="button"
                            data-bind="click: addToArea, text: name, event: { mouseover: highlight, mouseout: unHighlight }, css: { selected: selected, highlighted: highlighted }">
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div id="errors" class="span12" data-bind="foreach: persistence.errors, css: { found : persistence.errors().length > 0 }">
                <div class="alert alert-error">
                    <strong>Error</strong> <span data-bind="text: code"></span> <span data-bind="text: text"></span> Try again?
                </div>
            </div>
        </div>

        </section>
    </div>

<script type="application/javascript">

$(function($) {
    function NiceToHaveAppViewModel(categoriseView) {
        // Data
        var self = this;
        self.persistence = new Persistence();
        self.board = new Board(self.persistence);
        self.selectedList = ko.observable();

        self.cardsInArea = ko.computed(function() {
            if (self.selectedList()) {
                return self.selectedList().cards().filter(function(c) {
                    return c.inArea();
                });
            } else {
                return [];
            }
        });

        self.cardsHighlightedInArea = ko.computed(function() {
            if (self.selectedList()) {
                return self.cardsInArea().filter(function(c) {
                    return c.highlighted();
                });
            } else {
                return [];
            }
        });

        self.cardsInArea.subscribe(function(cards) {
            categoriseView.update(cards);
        });

        self.cardsHighlightedInArea.subscribe(function() {
            categoriseView.update(self.cardsInArea());
        });

        self.selectedList.subscribe(function(list){
            console.log("Selected list changed");
            list.refresh();
        });

        self.persistence.saveState.subscribe(function(state) {
            if (self.selectedList() && state === 'saved') {
                self.selectedList().refresh();
            }
        });

        self.goToBoardId = function() {
            location.hash = self.board.id();
        };

        Sammy(function () {
            this.get('#:boardId', function () {
                self.board.goToBoardId(this.params.boardId);
            });
        }).run();
    }

    var $board = $("#area");
    var boardOffset = $board.offset();
    var boardDimension = {
        width: $board.width(),
        height: $board.height()
    };
    var originOffset = $("#area .origin").offset();

    var width = boardDimension.width - (originOffset.left - boardOffset.left);
    var height = boardDimension.height - (originOffset.top - boardOffset.top);

    var categoriseView = new D3CategoriseView(originOffset.top, originOffset.left, width, height);

    var model = new NiceToHaveAppViewModel(categoriseView);

    ko.applyBindings(model);

    model.persistence.saveState.subscribe(function(state) {
        if (state === 'saving') {
            $.blockUI();
        }
        else {
            $.unblockUI();
        }
    });

    Trello.authorize({
        interactive:false,
        success: model.updateLoggedIn
    });
});

</script>

  <!--! KICKSTRAP FOOTER -->
   <div class="hidden"><h1>No Stylesheet Loaded</h1><p><strong>Could not load Kickstrap.</strong>There are <a href="http://getkickstrap.com/docs/1.2/troubleshooting/#lessjs-errors">several common reasons for this error.</a></p></div>
  <div id="push"></div></div> <!-- sf-wrapper -->
  <footer class="container" id="footer">
      <p><a href="http://blog.houseofmoran.com/tagged/nicetohave">Built</a> with
          <a href="http://getkickstrap.com">Kickstrap</a>,
          <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>,
          <a href="https://trello.com/docs/gettingstarted/clientjs.html">Trello JS API</a>,
          <a href="http://jquery.com/">jquery</a>,
          <a href="http://d3js.org/">D3</a>,
          <a href="http://knockoutjs.com/">Knockout.js</a>,
          <a href="http://sammyjs.org/">Sammy.js</a>,
          <a href="http://nodejs.org/">Node</a>,
          <a href="http://expressjs.com/">Express</a>,
          <a href="http://embeddedjs.com/">EJS</a>,
          <a href="http://lesscss.org/">Less</a>
          and copious helpings of <a href="http://stackoverflow.com/">Stack Overflow</a>.</p>
  </footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="Kickstrap/js/jquery-1.8.2.min.js"><\/script>');</script>
  <!-- Kickstrap CDN thanks to our friends at netDNA.com -->
  <script id="appList" src="//netdna.getkickstrap.com/1.2/Kickstrap/js/kickstrap.min.js"></script>
  <script>window.ks || document.write('<script id="appList" src="/Kickstrap/js/kickstrap.min.js"><\/script>')</script>
  <script>

  </script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37323701-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
