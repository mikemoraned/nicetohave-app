// Generated by CoffeeScript 1.6.1
(function() {
  var D3CategorisationView, _ref,
    _this = this;

  if ((_ref = window.nicetohave) == null) {
    window.nicetohave = {};
  }

  D3CategorisationView = (function() {

    function D3CategorisationView(rootSelector, width, height, maxRadius) {
      var _this = this;
      this.rootSelector = rootSelector;
      this.width = width;
      this.height = height;
      this.maxRadius = maxRadius != null ? maxRadius : 10;
      this._updateDisplay = function(mapped) {
        return D3CategorisationView.prototype._updateDisplay.apply(_this, arguments);
      };
      this._clampY = function(y) {
        return D3CategorisationView.prototype._clampY.apply(_this, arguments);
      };
      this._clampX = function(x) {
        return D3CategorisationView.prototype._clampX.apply(_this, arguments);
      };
      this._assignToUncategorisedSlot = function(mapping) {
        return D3CategorisationView.prototype._assignToUncategorisedSlot.apply(_this, arguments);
      };
      this._mappingForCategorisation = function(c) {
        return D3CategorisationView.prototype._mappingForCategorisation.apply(_this, arguments);
      };
      this.subscribeTo = function(categorisations) {
        return D3CategorisationView.prototype.subscribeTo.apply(_this, arguments);
      };
      this._resetUncategorisedArea = function() {
        return D3CategorisationView.prototype._resetUncategorisedArea.apply(_this, arguments);
      };
      this._setupDragBehaviour = function() {
        return D3CategorisationView.prototype._setupDragBehaviour.apply(_this, arguments);
      };
      this._setupScales = function() {
        return D3CategorisationView.prototype._setupScales.apply(_this, arguments);
      };
      this._setup = function() {
        return D3CategorisationView.prototype._setup.apply(_this, arguments);
      };
      this._setup();
      this._existingMappingForCategorisation = {};
    }

    D3CategorisationView.prototype._setup = function() {
      this.root = d3.select(this.rootSelector);
      this._setupScales();
      this._setupDragBehaviour();
      return this._resetUncategorisedArea();
    };

    D3CategorisationView.prototype._setupScales = function() {
      this.valueScale = d3.scale.linear().domain([0, 1]).range([this.maxRadius, this.width - this.maxRadius]).clamp(true);
      this.riskScale = d3.scale.linear().domain([0, 1]).range([this.maxRadius, 0.75 * (this.height - this.maxRadius)]).clamp(true);
      this.uncategorisedValueScale = this.valueScale;
      return this.uncategorisedRiskScale = d3.scale.linear().domain([0, 1]).range([0.75 * (this.height - this.maxRadius), this.height - this.maxRadius]).clamp(true);
    };

    D3CategorisationView.prototype._setupDragBehaviour = function() {
      var dragend, dragmove, self,
        _this = this;
      self = this;
      dragmove = function(d) {
        return d3.select(this).attr("cx", d.x = self._clampX(d3.event.x)).attr("cy", d.y = self._clampY(d3.event.y));
      };
      dragend = function(d) {
        var newRisk, newValue;
        newValue = _this.valueScale.invert(d.x);
        newRisk = _this.riskScale.invert(d.y);
        d.cat.axis("value").value(newValue);
        return d.cat.axis("risk").value(newRisk);
      };
      return this.drag = d3.behavior.drag().origin(Object).on("drag", dragmove).on("dragend", dragend);
    };

    D3CategorisationView.prototype._resetUncategorisedArea = function() {
      var freeX;
      this._nextFreeSlot = 0;
      this._nextFreeSlotXSpacing = this.maxRadius * 2.5;
      this._nextFreeSlotYSpacing = this._nextFreeSlotXSpacing;
      this._nextFreeSlotXOffset = this.maxRadius * 1.5;
      this._nextFreeSlotYOffset = (0.75 * this.height) + this._nextFreeSlotYSpacing;
      freeX = this.width - (this._nextFreeSlotXOffset * 2);
      return this._cardsPerX = freeX / this._nextFreeSlotXSpacing;
    };

    D3CategorisationView.prototype.subscribeTo = function(categorisations) {
      var _this = this;
      this.mapped = ko.computed(function() {
        return categorisations().map(_this._mappingForCategorisation);
      });
      this.mapped.subscribe(this._updateDisplay);
      this._updateDisplay(this.mapped());
      return this._resetUncategorisedArea();
    };

    D3CategorisationView.prototype._mappingForCategorisation = function(c) {
      var id, mapping;
      id = c.card.id();
      mapping = this._existingMappingForCategorisation[id];
      if (mapping == null) {
        mapping = {
          id: id,
          cat: c
        };
        this._existingMappingForCategorisation[id] = mapping;
      }
      if (c.fullyDefined()) {
        mapping.x = this.valueScale(c.axis("value").value());
        mapping.y = this.riskScale(c.axis("risk").value());
      } else {
        this._assignToUncategorisedSlot(mapping);
        mapping.x = mapping.uncategorisedX;
        mapping.y = mapping.uncategorisedY;
      }
      return mapping;
    };

    D3CategorisationView.prototype._assignToUncategorisedSlot = function(mapping) {
      if (mapping.uncategorisedSlot == null) {
        mapping.uncategorisedSlot = this._nextFreeSlot;
        mapping.uncategorisedX = ((this._nextFreeSlot % this._cardsPerX) * this._nextFreeSlotXSpacing) + this._nextFreeSlotXOffset;
        mapping.uncategorisedY = (Math.floor(this._nextFreeSlot / this._cardsPerX) * this._nextFreeSlotYSpacing) + this._nextFreeSlotYOffset;
        return this._nextFreeSlot++;
      }
    };

    D3CategorisationView.prototype._clampX = function(x) {
      return Math.max(this.maxRadius, Math.min(x, this.width - this.maxRadius));
    };

    D3CategorisationView.prototype._clampY = function(y) {
      return Math.max(this.maxRadius, Math.min(y, this.height - this.maxRadius));
    };

    D3CategorisationView.prototype._updateDisplay = function(mapped) {
      var existingCategorisations, newCategorisationCircles, newCategorisations,
        _this = this;
      existingCategorisations = this.root.selectAll("circle.card").data(mapped, function(d) {
        return d.id;
      });
      existingCategorisations.transition().duration(200).attr("cx", function(d) {
        return d.x;
      }).attr("cy", function(d) {
        return d.y;
      }).select("title").text(function(d) {
        return d.cat.card.name();
      });
      newCategorisations = existingCategorisations.enter();
      newCategorisationCircles = newCategorisations.append("circle").attr("class", "card").attr("r", this.maxRadius).call(this.drag);
      newCategorisationCircles.append("title").text(function(d) {
        return d.cat.card.name();
      });
      newCategorisationCircles.attr("cx", function(d) {
        return d.x;
      }).attr("cy", function(d) {
        return d.y;
      });
      return existingCategorisations.exit().transition().duration(200).style("opacity", 0).duration(250).attr("cy", function(d) {
        return _this.riskScale(4);
      }).remove();
    };

    return D3CategorisationView;

  })();

  window.nicetohave.D3CategorisationView = D3CategorisationView;

}).call(this);
