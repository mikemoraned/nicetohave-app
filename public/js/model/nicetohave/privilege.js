// Generated by CoffeeScript 1.6.1
(function() {
  var Privilege, _ref;

  if ((_ref = window.nicetohave) == null) {
    window.nicetohave = {};
  }

  Privilege = (function() {

    function Privilege(trello) {
      this.trello = trello;
      this.level = ko.observable(nicetohave.PrivilegeLevel.NONE);
      this.changingLevel = ko.observable(false);
      this.callDepth = ko.observable(0);
      this.callDepth.subscribe(function(d) {
        return console.log("Depth: " + d);
      });
    }

    Privilege.prototype.using = function(expectedLevel, fn) {
      var tracked,
        _this = this;
      tracked = function(trello) {
        _this.callDepth(_this.callDepth() + 1);
        fn(trello);
        return _this.callDepth(_this.callDepth() - 1);
      };
      if (this.level().satisfies(expectedLevel)) {
        return tracked(this.trello);
      } else {
        console.log("Raising level to");
        console.dir(expectedLevel);
        return this.raiseTo(expectedLevel, tracked);
      }
    };

    Privilege.prototype.raiseTo = function(level, success) {
      var _this = this;
      this.changingLevel(true);
      this.trello.deauthorize();
      this.level(nicetohave.PrivilegeLevel.NONE);
      return this.trello.authorize({
        type: "popup",
        name: "Nice to have",
        success: function() {
          console.log("Success!");
          _this.level(level);
          _this.changingLevel(false);
          return success(_this.trello);
        },
        error: function(m) {
          _this.changingLevel(false);
          return console.log("Error: " + m);
        },
        scope: level.trelloScope
      });
    };

    return Privilege;

  })();

  window.nicetohave.Privilege = Privilege;

}).call(this);
